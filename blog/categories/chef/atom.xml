<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Chef | ni-blog]]></title>
  <link href="http://orihubon.com/blog/categories/chef/atom.xml" rel="self"/>
  <link href="http://orihubon.com/"/>
  <updated>2015-08-19T15:05:57+09:00</updated>
  <id>http://orihubon.com/</id>
  <author>
    <name><![CDATA[niku4i]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[/etc/sysctl.confを管理するChef cookbook]]></title>
    <link href="http://orihubon.com/blog/2014/03/26/sysctl-chef-cookbook/"/>
    <updated>2014-03-26T22:49:00+09:00</updated>
    <id>http://orihubon.com/blog/2014/03/26/sysctl-chef-cookbook</id>
    <content type="html"><![CDATA[<p>Chefでsysctl.confを管理するやつ作ってみた。<a href="https://github.com/niku4i/sysctl-cookbook">niku4i/sysctl-cookbook</a></p>

<!--more-->


<p>なかのコードはonehealth-cookbooksさんの<a href="https://github.com/onehealth-cookbooks/sysctl">onehealth-cookbooks/sysctl</a>から必要最小限必要な部分だけかいつまみました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[test-kitchen使ったメモ]]></title>
    <link href="http://orihubon.com/blog/2014/03/25/test-kitchenshi-tutamemo/"/>
    <updated>2014-03-25T11:46:00+09:00</updated>
    <id>http://orihubon.com/blog/2014/03/25/test-kitchenshi-tutamemo</id>
    <content type="html"><![CDATA[<p>最近はImmutable Infrastracture盛り上がりでChefやPuppetが語られる機会が少なくなって気がしますが、それはChef/Puppetが成熟してきた証拠? test-kitchenを使ってみたメモです。</p>

<!--more-->


<p><a href="http://kitchen.ci/docs/getting-started">GETTING STARTED GUIDE</a> を写経。詳細はリンク先の原文を参照してください。</p>

<p>拙作の<a href="https://github.com/niku4i/rbenv-cookbook">rbenv-cookbook</a>をtest-kitchenをつかってVagrant上の仮想マシンでテストするところまで進めました。なお、Vagrantのバージョンは1.5.1を使いました。</p>

<h3>インストール</h3>

<p><code>
$ gem install test-kitchen
$ kitchen -v
Test Kitchen version 1.2.1
</code></p>

<p>また、あらかじめcookbookをgit cloneしておきます</p>

<p><code>
$ git clone git@github.com:niku4i/rbenv-cookbook.git
$ cd rbenv-cookbook
</code></p>

<h3>kitchen init</h3>

<p>```
$ kitchen init &mdash;driver=kitchen-vagrant</p>

<pre><code>  create  .kitchen.yml
  create  test/integration/default
  create  .gitignore
  append  .gitignore
  append  .gitignore
     run  gem install kitchen-vagrant from "."
</code></pre>

<p>Fetching: kitchen-vagrant-0.14.0.gem (100%)
Successfully installed kitchen-vagrant-0.14.0
Parsing documentation for kitchen-vagrant-0.14.0
Installing ri documentation for kitchen-vagrant-0.14.0
1 gem installed
```</p>

<p>.kitchen.ymlが作られた。中身は以下のとおり。ubuntuはひとまず不要なのでplatformから削除。またinitで作成されたyamlに登録されているcentos-6.4ではkitchen createしたときにvagrant upできなくてエラーになってしまったので、boxイメージが悪いのかなと判断して6.5を使うように変更した。</p>

<h2>```</h2>

<p>driver:
  name: vagrant</p>

<p>provisioner:
  name: chef_solo</p>

<p>platforms:</p>

<h1>&ndash; name: ubuntu-12.04</h1>

<h1>&ndash; name: centos-6.4</h1>

<ul>
<li>name: centos-65</li>
</ul>


<p>suites:
  &ndash; name: default</p>

<pre><code>run_list:
  - recipe[rbenv-cookbook::default]
attributes:
</code></pre>

<p>```</p>

<p>kitchen listコマンドで確認できた。</p>

<p><code>
$ kitchen list
Instance           Driver   Provisioner  Last Action
default-centos-64  Vagrant  ChefSolo     &lt;Not Created&gt;
</code></p>

<h3>kitchen create</h3>

<p>kitchen createでインスタンスをアップ</p>

<p>```
 $ kitchen create default-centos-65
&mdash;&mdash;&ndash;> Starting Kitchen (v1.2.1)
&mdash;&mdash;&ndash;> Creating &lt;default-centos-65>&hellip;</p>

<pre><code>   Bringing machine 'default' up with 'virtualbox' provider...
   ==&gt; default: Box 'opscode-centos-6.5' could not be found. Attempting to find and install...
       default: Box Provider: virtualbox
       default: Box Version: &gt;= 0
   ==&gt; default: Adding box 'opscode-centos-6.5' (v0) for provider: virtualbox
       default: Downloading: https://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_centos-6.5_chef-provisionerless.box
   ==&gt; default: Successfully added box 'opscode-centos-6.5' (v0) for 'virtualbox'!
   ==&gt; default: Importing base box 'opscode-centos-6.5'...
   ==&gt; default: Matching MAC address for NAT networking...
   ==&gt; default: Setting the name of the VM: default-centos-65_default_1395719095721_73691
   ==&gt; default: Fixed port collision for 22 =&gt; 2222. Now on port 2201.
   ==&gt; default: Clearing any previously set network interfaces...
   ==&gt; default: Preparing network interfaces based on configuration...
       default: Adapter 1: nat
   ==&gt; default: Forwarding ports...
       default: 22 =&gt; 2201 (adapter 1)
   ==&gt; default: Running 'pre-boot' VM customizations...
   ==&gt; default: Booting VM...
</code></pre>

<p>==> default: Waiting for machine to boot. This may take a few minutes&hellip;           default: SSH address: 127.0.0.1:2201</p>

<pre><code>       default: SSH username: vagrant
       default: SSH auth method: private key
       default: Error: Connection timeout. Retrying...
   ==&gt; default: Machine booted and ready!
   ==&gt; default: Checking for guest additions in VM...
       default: The guest additions on this VM do not match the installed version of
       default: VirtualBox! In most cases this is fine, but in rare cases it can
       default: prevent things such as shared folders from working properly. If you see
       default: shared folder errors, please make sure the guest additions within the
       default: virtual machine match the version of VirtualBox you have installed on
       default: your host and reload your VM.
       default:
       default: Guest Additions Version: 4.3.8
       default: VirtualBox Version: 4.2
   ==&gt; default: Setting hostname...
   Vagrant instance &lt;default-centos-65&gt; created.
   Finished creating &lt;default-centos-65&gt; (11m27.39s).
</code></pre>

<p>&mdash;&mdash;&ndash;> Kitchen is finished. (11m27.70s)
```</p>

<ul>
<li>vagrantでインスタンスを起動する</li>
<li>boxが登録されてなければネットワークから探してくる</li>
</ul>


<p><code>
$ kitchen list
Instance           Driver   Provisioner  Last Action
default-centos-65  Vagrant  ChefSolo     Created
</code></p>

<h3>kitchen converge</h3>

<p>レシピをインスタンスに適用する</p>

<p>```
$ kitchen converge default-centos-65
&mdash;&mdash;&ndash;> Starting Kitchen (v1.2.1)
&mdash;&mdash;&ndash;> Converging &lt;default-centos-65>&hellip;</p>

<pre><code>   Preparing files for transfer
   Preparing current project directory as a cookbook
   Removing non-cookbook files before transfer
</code></pre>

<p>&mdash;&mdash;&ndash;> Installing Chef Omnibus (true)</p>

<pre><code>   downloading https://www.getchef.com/chef/install.sh
     to file /tmp/install.sh
   trying wget...
   Downloading Chef  for el...
   downloading https://www.getchef.com/chef/metadata?v=&amp;prerelease=false&amp;p=el&amp;pv=6&amp;m=x86_64
     to file /tmp/install.sh.1851/metadata.txt
   trying wget...
   url      https://opscode-omnibus-packages.s3.amazonaws.com/el/6/x86_64/chef-11.10.4-1.el6.x86_64.rpm
   md5      3fe6dd8e19301b6c66032496a89097db
   sha256   edd5d2bcc174f67e5e5136fd7e5fffd9414c5f4949c68b28055b124185904d9f
   downloaded metadata file looks valid...
   downloading https://opscode-omnibus-packages.s3.amazonaws.com/el/6/x86_64/chef-11.10.4-1.el6.x86_64.rpm
     to file /tmp/install.sh.1851/chef-11.10.4-1.el6.x86_64.rpm
   trying wget...
   Comparing checksum with sha256sum...
   Installing Chef
   installing with rpm...
   warning: /tmp/install.sh.1851/chef-11.10.4-1.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID 83ef826a: NOKEY
</code></pre>

<p>Preparing&hellip;                #####  ########################################### [100%]
   1:chef                          ########################################### [100%]</p>

<pre><code>   Thank you for installing Chef!
   Transfering files to &lt;default-centos-65&gt;
   [2014-03-25T03:51:33+00:00] INFO: Forking chef instance to converge...
   Starting Chef Client, version 11.10.4
   [2014-03-25T03:51:33+00:00] INFO: *** Chef 11.10.4 ***
   [2014-03-25T03:51:33+00:00] INFO: Chef-client pid: 1948
   [2014-03-25T03:51:34+00:00] INFO: Setting the run_list to ["recipe[rbenv-cookbook::default]"] from JSON
   [2014-03-25T03:51:34+00:00] INFO: Run List is [recipe[rbenv-cookbook::default]]
   [2014-03-25T03:51:34+00:00] INFO: Run List expands to [rbenv-cookbook::default]
   [2014-03-25T03:51:34+00:00] INFO: Starting Chef Run for default-centos-65
   [2014-03-25T03:51:34+00:00] INFO: Running start handlers
   [2014-03-25T03:51:34+00:00] INFO: Start handlers complete.
   Compiling Cookbooks...

   Running handlers:
   [2014-03-25T03:51:34+00:00] ERROR: Running exception handlers
   Running handlers complete

   [2014-03-25T03:51:34+00:00] ERROR: Exception handlers complete
   [2014-03-25T03:51:34+00:00] FATAL: Stacktrace dumped to /tmp/kitchen/cache/chef-stacktrace.out
   Chef Client failed. 0 resources updated in 0.458583313 seconds
   [2014-03-25T03:51:34+00:00] ERROR: Cookbook yum-epel not found. If you're loading yum-epel from another cookbook, make sure you configure the dependency in your metadata
   [2014-03-25T03:51:34+00:00] FATAL: Chef::Exceptions::ChildConvergeError: Chef run process exited unsuccessfully (exit code 1)
</code></pre>

<blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><p>Converge failed on instance &lt;default-centos-65>.
Please see .kitchen/logs/default-centos-65.log for more details
&mdash;&mdash;&mdash;Exception&mdash;&mdash;&mdash;&ndash;
Class: Kitchen::ActionFailed
Message: SSH exited (1) for command: [sudo -E chef-solo &mdash;config /tmp/kitchen/solo.rb &mdash;json-attributes /tmp/kitchen/dna.json  &mdash;log_level info]
```</p></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote>

<p>エラーでこけた&hellip; 。rbenv-cookbookはyum-epelに依存してるせい? metadata.rbは既に作ってるのでBerkshelfファイルを作成しmetadataを読み込むようにしたらエラーをパスできた!</p>

<p>```text Berksfile
source &ldquo;<a href="https://api.berkshelf.com">https://api.berkshelf.com</a>&rdquo;</p>

<p>metadata
```</p>

<p>再実行。gitが無いので止まった。これはレシピが悪い。</p>

<p><code>ruby recipes/default.rb
...snip...
+ package "git"
...snip...
</code></p>

<p>再実行!無事終了!</p>

<p>kitchen convergeでやること</p>

<ul>
<li>インスタンスにChefをインストール</li>
<li>依存関係のレシピをインストール</li>
<li>.kitchen.ymlのrun_listを実行</li>
</ul>


<h3>手動で確認する</h3>

<p>ここまででレシピをエラー無くインスタンスに適用できることを確認した。手動でログインし確認する。</p>

<p><code>
$ kitchen login default-centos-65
Last login: Tue Mar 25 03:59:38 2014 from 10.0.2.2
[vagrant@default-centos-65 ~]$
</code></p>

<p>ログインできた。rbenvインストールされている。</p>

<p><code>
$ rbenv
rbenv 0.4.0-95-gf71e227
Usage: rbenv &lt;command&gt; [&lt;args&gt;]
</code></p>

<h3>テストを書く</h3>

<p>ServerSpecを使いたいところではあるが、ここではチュートリアルに従ってBusserというテストフレームワークでテストを書く。</p>

<p>テスト用のディレクトリを作成</p>

<p><code>
mkdir -p test/integration/default/bats
</code></p>

<p>今回は実行ファイルが存在するかどうかだけチェックした。</p>

<p>```text test/integration/default/bats/rbenv_installed.bats</p>

<h1>!/usr/bin/env bats</h1>

<p>@test &ldquo;executable rbenv command is found&rdquo; {
  run test -x /usr/local/rbenv/bin/rbenv
  [ &ldquo;$status&rdquo; -eq 0 ]
}</p>

<p>```</p>

<p>テストを流す</p>

<p>```
$ kitchen veryfy default-centos-65</p>

<p>&mdash;&mdash;&ndash;> Starting Kitchen (v1.2.1)
&mdash;&mdash;&ndash;> Verifying &lt;default-centos-65>&hellip;</p>

<pre><code>   Removing /tmp/busser/suites/bats
   Uploading /tmp/busser/suites/bats/rbenv_installed.bats (mode=0644)
</code></pre>

<p>&mdash;&mdash;&ndash;> Running bats test suite
 ✓ executable rbenv command is found</p>

<pre><code>   1 test, 0 failures
   Finished verifying &lt;default-centos-65&gt; (0m1.30s).
</code></pre>

<p>&mdash;&mdash;&ndash;> Kitchen is finished. (0m2.12s)
```</p>

<h3>kitchen test</h3>

<p>いままでやってきたことを全工程流す。</p>

<p><code>
$ kitchen veryfy default-centos-65  
</code></p>

<ul>
<li>既存のインスタンスがあれば廃棄する</li>
<li>インスタンス作成</li>
<li>Chefのインストール</li>
<li>レシピのインストール</li>
<li>テストの実行</li>
<li>インスタンスの廃棄</li>
</ul>


<h3>感想</h3>

<p>test kitchenよい。でも初回遅い。boxが最初ないと更に遅い。この辺はVagrantをDockerに変えるというアプローチがあるとおもうが気軽ではない感じかも。しばらく使ってみる!</p>
]]></content>
  </entry>
  
</feed>
