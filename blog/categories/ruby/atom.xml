<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Ruby | ni-blog]]></title>
  <link href="http://orihubon.com/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://orihubon.com/"/>
  <updated>2013-07-31T14:15:52+09:00</updated>
  <id>http://orihubon.com/</id>
  <author>
    <name><![CDATA[niku4i]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ActiveRecordのtypeフィールドについて]]></title>
    <link href="http://orihubon.com/blog/2013/07/29/type-column-of-activerecord/"/>
    <updated>2013-07-29T16:26:00+09:00</updated>
    <id>http://orihubon.com/blog/2013/07/29/type-column-of-activerecord</id>
    <content type="html"><![CDATA[<p>ActiveRecord::Baseを継承したモデルクラスで"type"という名前のフィールドを使おうとすると、</p>

<p><code>
ActiveRecord::SubclassNotFound: The single-table inheritance mechanism failed to locate the subclass: 'abc123'. This error is raised because the column 'type' is reserved for storing the class in case of inheritance. Please rename this column if you didn't intend it to be used for storing the inheritance class or overwrite Graph.inheritance_column to use another column for that information.
</code></p>

<p>という例外に遭遇します。ActiveRecordでは"type"フィールドはSTIという機能により予約されています。 <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">ActiveRecordのSTIの説明</a>にtypeフィールドは継承関係にあるクラス名を保存するフィールドであることが書かれています。</p>

<blockquote><p>Active Record allows inheritance by storing the name of the class in a column
that by default is named “type” (can be changed by overwriting
Base.inheritance_column).</p></blockquote>

<p>このエラーを回避するには以下どちらかで対応します。</p>

<ol>
<li>typeというフィールド名を使うのをやめて別の名前を使う。</li>
<li>もしくは、STIで使うフィールド名を変えてしまう。</li>
</ol>


<p>2のケースでは以下のようにします。</p>

<p><code>ruby app/models/campany.rb
class Company &lt; ActiveRecord::Base; end
  self.inheritance_column = 'sti_type'
end
</code></p>

<p>ケースバイケースですが、ある案件ではtypeフィールドをどうしても使いたかったので2の方法を取りました。type名以外の選択が可能であれば1のケースが良いとおもいます。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BUNDLE_FROZENとかBUNDLE_WITHOUT]]></title>
    <link href="http://orihubon.com/blog/2013/07/26/bundle-frozen-and-bundle-without/"/>
    <updated>2013-07-26T16:37:00+09:00</updated>
    <id>http://orihubon.com/blog/2013/07/26/bundle-frozen-and-bundle-without</id>
    <content type="html"><![CDATA[<p>bundlerの<code>--deployment</code>や<code>--without</code>に関してはまったことのメモ。</p>

<!--more-->


<h3>bundle install &mdash;deployment</h3>

<p><code>--deployment</code>をつけ実行すると<code>vendor/bundle</code>以下にgemがインストールされます。deploymentの名の通り本番環境でインストールする場合を想定したコマンドです。</p>

<p>```</p>

<pre><code>$ bundle install --deployment
</code></pre>

<p>```</p>

<h3>BUNDLE_FROZEN</h3>

<p><code>--deployment</code>の名のとおり本番環境でインストールする場合を想定したコマンドですが、うっかり開発環境で実行してしまって少々はまってしまいました。</p>

<p>開発環境でGemfileに新しくgemを追加したので、<code>bundle install</code>しようとします。すると</p>

<p><code>``
$ bundle install
You are trying to install in deployment mode after changing
your Gemfile. Run</code>bundle install` elsewhere and add the
updated Gemfile.lock to version control.</p>

<p>If this is a development machine, remove the Gemfile freeze
by running <code>bundle install --no-deployment</code>.</p>

<p>You have added to the Gemfile:
* colorize
```</p>

<p>とエラーがでます。<code>bundle install --deployment</code>を1度でも実行すると<code>.bundle/config</code>が更新され<code>BUNDLE_FROZEN: 1</code>が付加されるようです。</p>

<p>これを解除するには、<code>bundle install --no-deployment</code>を1度実行するか、<code>.bundle/config</code>を直接編集して<code>BUNDLE_FROZEN: 1</code>の行を削除してしまうかする必要があります。</p>

<h3>BUNDLE_WITHOUT</h3>

<p><code>--without</code>というオプションがあります。以下のように使います。本番環境ではdevelopmentやtestグループのgemは不要なのでwithoutでinstall対象から除外することができます。</p>

<p><code>
  $ bundle install --deployment --without development test
</code></p>

<p>ただ、これも<code>--without</code>つきで実行すると<code>.bundle/config</code>に保存されてしまいます。</p>

<h2>```</h2>

<p>BUNDLE_WITHOUT: development test
```</p>

<p>うっかり開発環境で実行してしまうと、その後、<code>bundle exec rspec</code>などやろうとすると以下のエラーが発生します。rspec-coreはGemに含まれませんと。</p>

<p><code>
$ bundle exec rpsec
/Users/name/.rbenv/versions/2.0.0-p195/lib/ruby/gems/2.0.0/gems/bundler-1.3.5/lib/bundler/rubygems_integration.rb:214:in `block in replace_gem': rspec-core is not part of the bundle. Add it to Gemfile. (Gem::LoadError)
</code></p>

<p>この場合も、<code>.bundle/config</code>を編集してBUNDLE_WITHOUTの行を削除すれば良いです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BSONオブジェクトのデータサイズを確認する方法(Ruby)]]></title>
    <link href="http://orihubon.com/blog/2013/02/13/calculate-bson-objects-size/"/>
    <updated>2013-02-13T15:06:00+09:00</updated>
    <id>http://orihubon.com/blog/2013/02/13/calculate-bson-objects-size</id>
    <content type="html"><![CDATA[<p>BSON Objectのサイズを求める方法。</p>

<pre><code>class Person
  include Mongoid::Document
  field :name, type: String
end

Person.create name: 'a'

person = Person.first
puts Moped::BSON::Document.serialize(parson.as_document).size
</code></pre>

<p>MongoDBにおける1BSONオブジェクトの最大サイズは16MB。ある件でembedしてデータをたくさん持たせた場合、サイズが制限内で妥当かどうか検証したときのメモ。</p>

<p>蛇足ならが、ちなみ結論的にはデータ構造がネストされて大きくなる場合はembededではなくreferencedを使うべきであった。</p>

<pre><code>class Person
  include Mongoid::Document
  field :name, type: String
  embeds_many :children
end

class Child
  include Mongoid::Document
  embeded_in :person
  field :age
end

Person.create name: 'a'
person = Person.first
person.children &lt;&lt; たくさんデータ入れる

Person.first   # loadに時間がかかる!
</code></pre>

<p>relationにした場合、子供はloadされないので時間がかかりません。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Twitterにリプライしたらgemが出来たお話]]></title>
    <link href="http://orihubon.com/blog/2013/01/12/capistrano-colorized-stream-gem-makes-log-monitoring-rainbow/"/>
    <updated>2013-01-12T01:03:00+09:00</updated>
    <id>http://orihubon.com/blog/2013/01/12/capistrano-colorized-stream-gem-makes-log-monitoring-rainbow</id>
    <content type="html"><![CDATA[<p>1年前に書いた<a href="http://orihubon.com/blog/2012/02/09/streaming-log-with-capistrano/">Streaming Log With Capistrano</a>というポストが巡り巡って<a href="https://github.com/sonots/capistrano-colorized-stream">gem</a>で利用できるようになりました、というお話。</p>

<blockquote class="twitter-tweet" data-in-reply-to="288609436531052544" lang="ja"><p>@<a href="https://twitter.com/sonots">sonots</a> だいぶ昔書いたのでいけてなコードですが、こんな感じでしょうか。<a href="http://t.co/nifOD1YA" title="http://orihubon.com/blog/2012/02/09/streaming-log-with-capistrano/">orihubon.com/blog/2012/02/0…</a></p>&mdash; Nobuhiro Nikushiさん (@niku4i) <a href="https://twitter.com/niku4i/status/288612474276691968" data-datetime="2013-01-08T11:45:50+00:00">1月 8, 2013</a></blockquote>


<script async src="http://orihubon.com//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p><a href="https://twitter.com/sonots/">@sonots</a>さんがCapistranoの話題のツイートしてて、昔似たことをやったので過去のポストを教えてあげたところgemになった!</p>

<blockquote class="twitter-tweet" lang="ja"><p>@<a href="https://twitter.com/niku4i">niku4i</a> gemにしてみましたよ！ <a href="https://t.co/Q2tjd0kj" title="https://github.com/sonots/capistrano-colorized-stream">github.com/sonots/capistr…</a></p>&mdash; そのっつ (SEO Naotoshi)さん (@sonots) <a href="https://twitter.com/sonots/status/289690981152989184" data-datetime="2013-01-11T11:11:26+00:00">1月 11, 2013</a></blockquote>


<script async src="http://orihubon.com//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p><a href="https://github.com/sonots/capistrano-colorized-stream">capistrano-colorized-stream</a></p>

<p><a href="https://twitter.com/sonots/">@sonots</a>さん仕事早い。</p>

<p>gemにしていただいたので僕はこれをネタにブログを書くことにしました。</p>

<!-- more -->


<h3>コードを読んでみた</h3>

<h4>alias_method</h4>

<p><code>ruby lib/capistrano/colorized_stream.rb
alias_method :stream_without_color, :stream
alias_method :stream, :stream_with_color
</code>
  * alias_methodを使うと既存メソッドは残しつつ、alias_methodで上書くことができるんですね
  * 実は<code>alias</code>との違いがピンときていないのでまた別途</p>

<p>試してみた。
``` ruby
class A
  def hello</p>

<pre><code>'Hello!'
</code></pre>

<p>  end
end</p>

<p>class A
  def aisatsu</p>

<pre><code>'Konichiwa!'
</code></pre>

<p>  end
  alias_method :greet, :hello
  alias_method :hello, :aisatsu
end</p>

<p>A.new.hello # => &ldquo;Konichiwa!&rdquo;
A.new.greet # => &ldquo;Hello!&rdquo;
<code>``
</code>A#hello<code>が日本語に変更しつつ、</code>A#greet`にてオリジナルの英語で挨拶することができました。</p>

<h4>String#split</h4>

<p><code>ruby lib/capistrano/colorized_stream.rb
lines = out.split(/\r?\n/m, -1)
</code>
  * <code>/\n/</code>ではなく<code>/\r?\n/</code>と各とCRLFとLFをサポートする
  * splitの第2引数に負の値を与え、改行のみの行を空要素として配列を返す。すると改行がどの位置にあるか気にしなくてもよくなる(!)。</p>

<p>この<code>split</code>の第2引数のようにRubyのコアクラスのAPIの知識に深ければ小さくコードが書ける実例だなとおもいました。
このあたりは<a href="http://www.amazon.co.jp/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E8%A8%80%E8%AA%9E-Ruby-%E3%81%BE%E3%81%A4%E3%82%82%E3%81%A8-%E3%82%86%E3%81%8D%E3%81%B2%E3%82%8D/dp/4873113946">プログラミング言語 Ruby</a>の9章Rubyプラットフォームが充実してますね。難しいコードを書いたな&hellip;.というときは標準のAPIで対応できないか、考え直してみるとよさそうですね。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TEDの英文を取得する]]></title>
    <link href="http://orihubon.com/blog/2012/04/09/fetch-subtitle-for-talks-in-ted/"/>
    <updated>2012-04-09T01:49:00+09:00</updated>
    <id>http://orihubon.com/blog/2012/04/09/fetch-subtitle-for-talks-in-ted</id>
    <content type="html"><![CDATA[<p>TEDのトークショーの内容をテキストデータで取得できるという話を聞きましたのでRubyで英文をprintするコードを書いてみました。</p>

<!-- more -->


<p>URLを叩くとJSONで返してくれるのでparseしてputsするだけでした。</p>

<p><div><script src='https://gist.github.com/2338391.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>

<p><a href="http://www.ted.com/talks/matt_cutts_try_something_new_for_30_days.html">Matt Cutts: Try something new for 30 days</a> という有名なTEDのトークをひとまずdumpしてみました。</p>

<pre><code>$ ./teddump.rb
A few years ago,

I felt like I was stuck in a rut,

so I decided to follow in the footsteps

of the great American philosopher, Morgan Spurlock,

and try something new for 30 days.

The idea is actually pretty simple.

Think about something you've always wanted to add to your life

and try it for the next 30 days.

It turns out, 

30 days is just about the right amount of time
</code></pre>

<p>できました。</p>

<p>ちなみに、idはページ中のHTMLのdata-idというパラメタから取得しないと分かりません。nokogiriとかでスクレイピングする方法があるようです。</p>

<p>以下を参考にしました。</p>

<ul>
<li><a href="http://stackoverflow.com/questions/1955618/parsing-and-converting-ted-talks-json-subtitles">Parsing and Converting TED Talks JSON Subtitles</a></li>
<li><a href="http://d.hatena.ne.jp/meganii/20120320/1332214416">TEDの英語原稿を取得する &ndash; ギークを夢見るじょーぶん男子 </a></li>
</ul>

]]></content>
  </entry>
  
</feed>
