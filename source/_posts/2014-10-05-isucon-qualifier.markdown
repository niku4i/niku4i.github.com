---
layout: post
title: "ISUCON 2014 予選の記録 GoMiami"
date: 2014-06-29 21:10
comments: true
categories: 
  - ISUCON
---

[ISUCON4 予選](http://isucon.net/archives/39780986.html)に参加しました。

<!--more-->

去年に引き続き2年目、[前年](http://orihubon.com/blog/2013/10/07/isucon3-yosen/)同様 @sonots, @Spring_MT と。チーム名はGoMiamiで。今回もマイアミがすこし関係します!!

去年はRubyだったのですが、Go言語覚えるきっかけにってことで、1ヶ月位前のチーム結成時に決定。僕は少し前に[A Tour of Go](http://go-tour-jp.appspot.com/) をひと通りやった程度。今回はインフラメインで2人はアプリコードメインに戦略立てるって感じで。

##### 事前準備

社内で1回前回大会の復習会をやったのと、チームで休日にあつまって前回予選課題を使って予行練習。当日どういう役割でどう動くかみたいなことを練習しました。この予行練習のお陰て今回予選はかなり余裕でました!! @sonots is our brain!

##### AM

午前中はボトルネック探しと、ベンチ特性、方針決めを中心にやった。ので午前中はチューニング作業は無し。

* 開始と同時にメンバ分のインスタンス立ち上げ、本番用インスタンス立ち上げ
* 本番環境整備(github pull&push環境)
* ベンチ1回走らせて、プロファイリング。具体的にはnginxのアクセスログ、slowqueryログ、からベンチの特性分析
* コード読んだり、画面見たり、ざっと。
* my.cnf, nginx.confを予め用意しておいた内容で置き換え

とりあえずMySQLのCPUが高いのはindexはって治すとして、それ以外はあまり無いなってことになって、アプリにオンメモリで乗せる戦略にした。
MySQLは5.5が動いてて、一応5.6に上げる方針にしたけど、これは最終的にオンメモリ戦略によりデータベースのアクセスが小さくなるので5.5で十分だった。

##### PM

飯食べながらさくっとMySQL5.6に上げたところで、この時点でアプリのオンメモリ戦略の実装待ちで実はやることが無かった(笑) アプリあっての外のチューニングなので、まあこの時間帯はコード眺めたりしつつお茶を濁しておりました。 アプリの改修が無事に終わって、MySQLのindexチューニングもいれて ここでスコアががくっと上がった。

スコア上がったのでさらにベンチ負荷上げて試したんだけど、CPU大して使ってないのにスコア上がらなくて。これはネットワーク周りかなということで`netstat -an | grep TIME_WAIT | wc -l` ってやると50kくらいでTIME_WAITがしめてたので、以下のチューニングしたらport足りなくなる問題は改善しました。

```
net.ipv4.ip_local_port_range = 10000 64000 
net.ipv4.tcp_tw_recycle=1
net.ipv4.tcp_fin_timeout = 5
net.ipv4.tcp_max_syn_backlog = 1024
net.core.somaxconn = 65535
```

結果としては最終的に40kあたりのレンジで他チームと横並びで、本戦出場は厳しそう...な感じですが、結果発表が楽しみです。
タイムラインとか詳細は[sonotsブログ](http://blog.livedoor.jp/sonots/archives/40449500.html)が充実している。

##### 反省

**Chef**

予選はミドルウェアとか毎回同じなのでChefレシピ用意しといてインフラ担当が3人分開発環境まで揃えてあげればよかった。今回開発環境は各自お任せだったのでコード読み書きに専念させてあげればよかったなと。


**Go**

Go力足りてなくて速読できなかった(笑) Spring_MT氏はrubyでコードを把握した後Goをfixしたよと言っていた。なるほど。


##### 所感

* 前回大会に比べ今回は余裕をもって想定した力は発揮できたことは進歩
* 前回大会であれば本戦出場できたなあ... (今回は40kレベルのチーム層が多くて、そこを抜き出る何かが必要だった)


